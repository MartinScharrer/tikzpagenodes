
\RequirePackage{atbegshi}
\RequirePackage{tikz}
\RequirePackage[strict]{changepage}

%\AtBeginShipoutNext{}%
%\AtBeginShipout{}%


\def\set@currentsidemargin{%
  \checkoddpage
  \ifoddpage
    \gdef\currentsidemargin{\oddsidemargin}%
  \else%
    \gdef\currentsidemargin{\evensidemargin}%
  \fi%
}

\tikzset{every picture/.append style={execute at begin picture={%
    \ifpgfrememberpicturepositiononpage%
        \set@currentsidemargin
    \fi
}}}



\def\current@textarea@left{(1in+\hoffset+\currentsidemargin)}
\def\current@textarea@top{(1in+\voffset+\topmargin+\headheight+\headsep)}

\expandafter\def\csname pgf@sh@ns@current page textarea\endcsname{rectangle}
\expandafter\def\csname pgf@sh@np@current page textarea\endcsname{%
    \def\southwest{\pgfpoint{\current@textarea@left}{\paperheight-\current@textarea@top-\textheight}}%
    \def\northeast{\pgfpoint{\current@textarea@left+\textwidth}{\paperheight-\current@textarea@top}}%
}
\expandafter\let\csname pgf@sh@nt@current page textarea\expandafter\endcsname\csname pgf@sh@nt@current page\endcsname
\expandafter\let\csname pgf@sh@pi@current page textarea\expandafter\endcsname\csname pgf@sh@pi@current page\endcsname




\expandafter\def\csname pgf@sh@ns@current page marginpar area\endcsname{rectangle}
\expandafter\def\csname pgf@sh@np@current page marginpar area\endcsname{%
    \def\southwest{%
        \ifoddpage
            \pgfpoint{\current@textarea@left+\textwidth+\marginparsep}{\paperheight-\current@textarea@top-\textheight}%
        \else
            \pgfpoint{\current@textarea@left-\marginparsep}{\paperheight-\current@textarea@top-\textheight}%
        \fi
    }
    \def\northeast{%
        \ifoddpage
            \pgfpoint{\current@textarea@left+\textwidth+\marginparsep+\marginparwidth}{\paperheight-\current@textarea@top}%
        \else
            \pgfpoint{\current@textarea@left-\marginparsep-\marginparwidth}{\paperheight-\current@textarea@top}%
        \fi
    }%
}
\expandafter\let\csname pgf@sh@nt@current page marginpar area\expandafter\endcsname\csname pgf@sh@nt@current page\endcsname
\expandafter\let\csname pgf@sh@pi@current page marginpar area\expandafter\endcsname\csname pgf@sh@pi@current page\endcsname



\expandafter\def\csname pgf@sh@ns@current page header area\endcsname{rectangle}
\expandafter\def\csname pgf@sh@np@current page header area\endcsname{%
    \def\southwest{\pgfpoint{\current@textarea@left}{\paperheight-\current@textarea@top+\headsep}}%
    \def\northeast{\pgfpoint{\current@textarea@left+\textwidth}{\paperheight-\current@textarea@top+\headsep+\headheight}}%
}
\expandafter\let\csname pgf@sh@nt@current page header area\expandafter\endcsname\csname pgf@sh@nt@current page\endcsname
\expandafter\let\csname pgf@sh@pi@current page header area\expandafter\endcsname\csname pgf@sh@pi@current page\endcsname



\expandafter\def\csname pgf@sh@ns@current page footer area\endcsname{rectangle}
\expandafter\def\csname pgf@sh@np@current page footer area\endcsname{%
    \def\southwest{\pgfpoint{\current@textarea@left}{\paperheight-\current@textarea@top-\textheight-\footskip}}%
    \def\northeast{\pgfpoint{\current@textarea@left+\textwidth}{\paperheight-\current@textarea@top-\textheight-\footskip+\headheight}}%
}
\expandafter\let\csname pgf@sh@nt@current page footer area\expandafter\endcsname\csname pgf@sh@nt@current page\endcsname
\expandafter\let\csname pgf@sh@pi@current page footer area\expandafter\endcsname\csname pgf@sh@pi@current page\endcsname



